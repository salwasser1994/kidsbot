import asyncio
import random
from aiogram import Bot, Dispatcher, F
from aiogram.types import Message, CallbackQuery, InlineKeyboardButton, InlineKeyboardMarkup

API_TOKEN = "ВАШ_ТОКЕН"

bot = Bot(token=API_TOKEN)
dp = Dispatcher()

# === ДЕТИ ===
users = {
    "Руслан": {"id": 7894501725, "birthday": "2014-10-04", "points": 0},
    "Алиса": {"id": 7719485802, "birthday": "2016-06-19", "points": 0},
    "Томас": {"id": 5205381793, "birthday": "1994-04-27", "points": 0},
}

# === ВИКТОРИНА (100 вопросов) ===
quiz_questions = [
    ("Столица Франции?", ["Париж", "Лондон", "Берлин", "Рим"], "Париж"),
    ("Самая длинная река в мире?", ["Амазонка", "Нил", "Волга", "Янцзы"], "Нил"),
    ("Как называется спутник Земли?", ["Марс", "Луна", "Венера", "Сатурн"], "Луна"),
    ("Кто написал 'Войну и мир'?", ["Толстой", "Пушкин", "Гоголь", "Чехов"], "Толстой"),
    ("Сколько ног у паука?", ["6", "8", "10", "12"], "8"),
    ("Какая планета ближе всего к Солнцу?", ["Меркурий", "Венера", "Марс", "Юпитер"], "Меркурий"),
    ("Какой цвет у моркови?", ["Красный", "Оранжевый", "Зелёный", "Фиолетовый"], "Оранжевый"),
    ("Сколько букв в русском алфавите?", ["32", "33", "34", "31"], "33"),
    ("Кто изобрёл лампу?", ["Эдисон", "Ньютон", "Тесла", "Дарвин"], "Эдисон"),
    ("Какое животное умеет летать?", ["Слон", "Пингвин", "Орёл", "Кенгуру"], "Орёл"),
    ("Какое насекомое производит мёд?", ["Муравей", "Пчела", "Бабочка", "Жук"], "Пчела"),
    ("Кто главный герой сказки 'Колобок'?", ["Колобок", "Лиса", "Заяц", "Волк"], "Колобок"),
    ("Какой океан самый большой?", ["Индийский", "Атлантический", "Тихий", "Северный Ледовитый"], "Тихий"),
    ("Кто живёт в улье?", ["Пчёлы", "Муравьи", "Птицы", "Бобры"], "Пчёлы"),
    ("Какой зверь самый быстрый на земле?", ["Гепард", "Лев", "Заяц", "Слон"], "Гепард"),
    ("Сколько планет в нашей Солнечной системе?", ["7", "8", "9", "10"], "8"),
    ("Кто написал 'Руслан и Людмила'?", ["Пушкин", "Толстой", "Гоголь", "Чехов"], "Пушкин"),
    ("Какая птица не умеет летать?", ["Страус", "Воробей", "Орёл", "Синица"], "Страус"),
    ("Самый большой материк?", ["Африка", "Евразия", "Антарктида", "Северная Америка"], "Евразия"),
    ("Как называется дом пчёл?", ["Нора", "Улей", "Гнездо", "Логово"], "Улей"),
    ("Что растёт из семени?", ["Дерево", "Ракета", "Дом", "Корабль"], "Дерево"),
    ("Как называется наука о растениях?", ["Ботаника", "Зоология", "Астрономия", "География"], "Ботаника"),
    ("Самое большое животное на Земле?", ["Слон", "Кит", "Медведь", "Жираф"], "Кит"),
    ("Как называется самая высокая гора в мире?", ["Эверест", "Килиманджаро", "Арарат", "Фудзи"], "Эверест"),
    ("Какой континент называют 'Чёрным континентом'?", ["Африка", "Азия", "Европа", "Америка"], "Африка"),
    ("Какой газ мы вдыхаем?", ["Кислород", "Углекислый газ", "Азот", "Гелий"], "Кислород"),
    ("Какое животное живёт в норе и ест морковь?", ["Заяц", "Лиса", "Волк", "Ёж"], "Заяц"),
    ("Какая планета известна как Красная планета?", ["Марс", "Венера", "Юпитер", "Сатурн"], "Марс"),
    ("Что растёт на деревьях?", ["Яблоки", "Камни", "Молоко", "Морковь"], "Яблоки"),
    ("Кто написал 'Приключения Незнайки'?", ["Носов", "Толстой", "Пушкин", "Чуковский"], "Носов"),
    ("Какое насекомое может прыгать очень высоко?", ["Кузнечик", "Бабочка", "Пчела", "Муха"], "Кузнечик"),
    ("Какой океан самый маленький?", ["Индийский", "Атлантический", "Тихий", "Северный Ледовитый"], "Северный Ледовитый"),
    ("Что помогает расти растениям?", ["Солнце", "Молоко", "Мыло", "Глина"], "Солнце"),
    ("Какой цвет получается при смешении синего и красного?", ["Зелёный", "Фиолетовый", "Оранжевый", "Жёлтый"], "Фиолетовый"),
    ("Какое животное хоботом?", ["Слон", "Жираф", "Лев", "Тигр"], "Слон"),
    ("Самая маленькая птица?", ["Колибри", "Воробей", "Синица", "Пингвин"], "Колибри"),
    ("Что можно найти в лесу?", ["Деревья", "Корабли", "Машины", "Дома"], "Деревья"),
    ("Какой зверь спит в берлоге зимой?", ["Медведь", "Лиса", "Заяц", "Ёж"], "Медведь"),
    ("Кто написал 'Доктор Айболит'?", ["Чуковский", "Толстой", "Пушкин", "Носов"], "Чуковский"),
    ("Какой зверь рычит?", ["Лев", "Заяц", "Кот", "Слон"], "Лев"),
    ("Что растёт в саду?", ["Фрукты", "Камни", "Мебель", "Лампы"], "Фрукты"),
    ("Какой цвет у неба в ясный день?", ["Синий", "Зелёный", "Красный", "Жёлтый"], "Синий"),
    ("Какая планета имеет кольца?", ["Сатурн", "Марс", "Венера", "Меркурий"], "Сатурн"),
    ("Какое насекомое светится ночью?", ["Светлячок", "Муха", "Бабочка", "Муравей"], "Светлячок"),
    ("Кто главный герой сказки 'Красная Шапочка'?", ["Красная Шапочка", "Лиса", "Волк", "Бабушка"], "Красная Шапочка"),
    ("Какая птица умеет говорить?", ["Попугай", "Воробей", "Синица", "Орёл"], "Попугай"),
    ("Какой зверь живёт в воде и на суше?", ["Лягушка", "Слон", "Лев", "Заяц"], "Лягушка"),
    ("Что делает пчела?", ["Собирает мёд", "Строит дом", "Пишет книги", "Летает на Луну"], "Собирает мёд"),
    ("Какая часть растения растёт под землёй?", ["Корень", "Стебель", "Лист", "Цветок"], "Корень"),
    ("Как называется наука о животных?", ["Зоология", "Ботаника", "Астрономия", "География"], "Зоология"),
    ("Какое животное полосатое и рычит?", ["Тигр", "Лев", "Медведь", "Слон"], "Тигр"),
    ("Что бывает солнечным или лунным?", ["День", "Ветер", "Дождь", "Снег"], "День"),
    ("Кто написал 'Малыш и Карлсон'?", ["Линдгрен", "Толстой", "Чуковский", "Носов"], "Линдгрен"),
    ("Какой зверь умеет плавать и носить ракушку?", ["Черепаха", "Слон", "Медведь", "Заяц"], "Черепаха"),
    ("Что помогает видеть ночью у животных?", ["Глаза", "Уши", "Руки", "Ноги"], "Глаза"),
    ("Самое большое насекомое?", ["Жук-геркулес", "Бабочка", "Муравей", "Муха"], "Жук-геркулес"),
    ("Какое дерево всегда остаётся зелёным?", ["Ёлка", "Берёза", "Дуб", "Липа"], "Ёлка"),
    ("Какая река протекает через Москву?", ["Москва", "Волга", "Нил", "Днепр"], "Москва"),
    ("Кто главный герой 'Приключения Незнайки'?", ["Незнайка", "Пончик", "Винтик", "Шпунтик"], "Незнайка"),
    ("Что растёт на грядке?", ["Овощи", "Диваны", "Книги", "Лампы"], "Овощи"),
    ("Какая птица делает гнездо из веток?", ["Ворона", "Утка", "Пингвин", "Фламинго"], "Ворона"),
    ("Какое животное умеет крутить панцирь?", ["Черепаха", "Заяц", "Лев", "Медведь"], "Черепаха"),
    ("Как называется наука о космосе?", ["Астрономия", "Ботаника", "Зоология", "Физика"], "Астрономия"),
    ("Какой зверь носит на себе панцирь?", ["Черепаха", "Слон", "Лев", "Тигр"], "Черепаха"),
    ("Что растёт на кактусе?", ["Иглы", "Листья", "Фрукты", "Цветы"], "Иглы"),
    ("Какая птица клюёт зерно?", ["Воробей", "Орёл", "Пингвин", "Сова"], "Воробей"),
    ("Кто главный герой 'Винни-Пуха'?", ["Винни-Пух", "Тигра", "Пятачок", "Кролик"], "Винни-Пух"),
    ("Что делают дождевые черви?", ["Перемешивают землю", "Летают", "Прыгают", "Плавают"], "Перемешивают землю"),
    ("Какое насекомое имеет рог на голове?", ["Жук-носорог", "Бабочка", "Муха", "Муравей"], "Жук-носорог"),
    ("Как называется большой водоём?", ["Озеро", "Лужа", "Ручей", "Колодец"], "Озеро"),
    ("Кто живёт в пустыне и носит горбы?", ["Верблюд", "Слон", "Кролик", "Лев"], "Верблюд"),
    ("Что растёт на деревьях и съедобно?", ["Фрукты", "Камни", "Металл", "Пластик"], "Фрукты"),
    ("Какая птица ночная и охотится на мышей?", ["Сова", "Воробей", "Голубь", "Журавль"], "Сова"),
    ("Какой цвет получается при смешении жёлтого и красного?", ["Оранжевый", "Зелёный", "Фиолетовый", "Синий"], "Оранжевый"),
    ("Самое высокое дерево?", ["Секвойя", "Берёза", "Дуб", "Липа"], "Секвойя"),
    ("Какое животное строит плотину?", ["Бобёр", "Медведь", "Лиса", "Кот"], "Бобёр"),
    ("Кто написал 'Бармалей'?", ["Чуковский", "Толстой", "Пушкин", "Носов"], "Чуковский"),
    ("Что помогает растениям дышать?", ["Листья", "Корни", "Ствол", "Цветок"], "Листья"),
    ("Какая птица самая быстрая?", ["Стриж", "Орёл", "Воробей", "Пингвин"], "Стриж"),
    ("Какое животное умеет менять цвет?", ["Хамелеон", "Крокодил", "Слон", "Лев"], "Хамелеон"),
    ("Что растёт в огороде?", ["Овощи", "Деревья", "Камни", "Лампы"], "Овощи"),
    ("Какой зверь питается листьями эвкалипта?", ["Коала", "Лев", "Слон", "Тигр"], "Коала"),
    ("Какой зверь умеет летать, но не птица?", ["Летучая мышь", "Орёл", "Сова", "Гусь"], "Летучая мышь"),
    ("Кто главный герой 'Приключений Пиноккио'?", ["Пиноккио", "Джинни", "Чип", "Гоффи"], "Пиноккио"),
    ("Что находится в небе и светит ночью?", ["Луна", "Солнце", "Река", "Гора"], "Луна"),
    ("Какое животное живёт в Антарктиде и умеет плавать?", ["Пингвин", "Белый медведь", "Тюлень", "Кит"], "Пингвин"),
    ("Какая птица самая большая?", ["Страус", "Орёл", "Сова", "Воробей"], "Страус"),
]
# === МЕНЮ ===
def main_menu():
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="🎮 Игры", callback_data="menu_games"),
         InlineKeyboardButton(text="📚 Учёба", callback_data="menu_study"),
         InlineKeyboardButton(text="📖 Сказки", callback_data="menu_fairytales")],
        [InlineKeyboardButton(text="🏆 Мои очки", callback_data="points"),
         InlineKeyboardButton(text="👤 Кто я", callback_data="whoami")],
        [InlineKeyboardButton(text="📅 Сколько дней до...", callback_data="birthday")]
    ])
    return kb

def back_menu():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="⬅️ Назад в главное меню", callback_data="back")]
    ])

def get_child(user_id: int):
    for name, data in users.items():
        if data["id"] == user_id:
            return name
    return None

# === АКТИВНЫЕ ИГРЫ ===
active_quiz = {}  # user_id: {"question_index": int, "questions": list, "last_text": Message}

# === ОБРАБОТЧИКИ ===
@dp.message(F.text)
async def start_menu(message: Message):
    await message.answer("Главное меню:", reply_markup=main_menu())

@dp.callback_query(F.data == "back")
async def back(callback: CallbackQuery):
    await callback.message.edit_text("Главное меню:", reply_markup=main_menu())

@dp.callback_query(F.data == "menu_games")
async def menu_games(callback: CallbackQuery):
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="🧠 Викторина", callback_data="quiz_start")],
        [InlineKeyboardButton(text="✊✌️✋ Камень-ножницы-бумага", callback_data="rps")],
        [InlineKeyboardButton(text="🎯 Угадывай", callback_data="guess_menu")],
        [InlineKeyboardButton(text="⬅️ Назад", callback_data="back")]
    ])
    await callback.message.edit_text("🎮 Игры — выбери:", reply_markup=kb)

@dp.callback_query(F.data == "quiz_start")
async def start_quiz(callback: CallbackQuery):
    user_name = get_child(callback.from_user.id)
    await callback.message.delete()
    if not user_name:
        await callback.message.answer("Играть могут только зарегистрированные дети.")
        return

    await callback.message.answer(
        f"🧠 Викторина!\n\nПравила:\n✅ Правильный ответ: +1 очко\n❌ Неправильный ответ: -1 очко\nУдачи, {user_name}!"
    )
    questions = quiz_questions.copy()
    random.shuffle(questions)
    active_quiz[callback.from_user.id] = {
        "question_index": 0,
        "questions": questions,
        "last_text": None
    }
    await send_quiz_question(callback.from_user.id, callback.message.chat.id)

async def send_quiz_question(user_id, chat_id, result_text=""):
    quiz = active_quiz[user_id]
    q_index = quiz["question_index"]
    if q_index >= len(quiz["questions"]):
        await bot.send_message(chat_id, f"Викторина закончена! Твои очки: {users[get_child(user_id)]['points']}")
        del active_quiz[user_id]
        return

    question, options, answer = quiz["questions"][q_index]
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=opt, callback_data=f"quiz_ans:{i}")] for i, opt in enumerate(options)
    ] + [[InlineKeyboardButton(text="⬅️ Назад в меню", callback_data="back")]])

    text = f"{result_text}\nВопрос {q_index + 1}: {question}" if result_text else f"Вопрос {q_index + 1}: {question}"
    if quiz["last_text"]:
        await quiz["last_text"].edit_text(text, reply_markup=kb)
    else:
        msg = await bot.send_message(chat_id, text, reply_markup=kb)
        quiz["last_text"] = msg

@dp.callback_query(F.data.startswith("quiz_ans:"))
async def quiz_answer(callback: CallbackQuery):
    user_id = callback.from_user.id
    user_name = get_child(user_id)
    if user_id not in active_quiz:
        await callback.answer("Викторина не активна")
        return

    quiz = active_quiz[user_id]
    q_index = quiz["question_index"]
    question, options, correct_answer = quiz["questions"][q_index]
    chosen_index = int(callback.data.split(":")[1])
    chosen_answer = options[chosen_index]

    if chosen_answer == correct_answer:
        users[user_name]["points"] += 1
        result_text = f"✅ Правильно, молодец {user_name}!"
        quiz["question_index"] += 1
    else:
        users[user_name]["points"] -= 1
        result_text = f"❌ Неправильно, {user_name}! Попробуй ещё раз."

    await send_quiz_question(user_id, callback.message.chat.id, result_text=result_text)

# === ЗАПУСК ===
if __name__ == "__main__":
    asyncio.run(dp.start_polling(bot))
